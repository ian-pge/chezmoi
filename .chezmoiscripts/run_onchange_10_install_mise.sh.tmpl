#!/usr/bin/env bash
# config.toml hash: {{ include "dot_config/mise/config.toml.tmpl" | sha256sum }}

set -euo pipefail

# Use mise env (not mise activate) â€” activate is for interactive shells only
eval "$(mise env -s bash 2>/dev/null || true)"

# ---- 2. Install Tools (Neovim, Node, Starship, etc.) ----
echo ">>> Installing tools via Mise..."

# NOTE: This script includes the content of config.toml directly.
# This ensures that we always install exactly what is defined in the template,
# without relying on chezmoi file placement order.

# Install all tools defined in ~/.config/mise/config.toml
mise install --yes

echo ">>> Verifying installation..."
# Sanity check: verify 'starship' was actually installed and is runnable.
# If verification fails, retry the install specifically for starship.
if ! ~/.local/bin/mise exec -- starship --version >/dev/null 2>&1; then
    echo "WARNING: Starship not found after mise install. Retrying..."
    mise install starship --yes
fi

# Ensure all shims (executable wrappers) are up to date
echo ">>> Reshimming mise..."
mise reshim

echo ">>> Mise tools installed successfully."
