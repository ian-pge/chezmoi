#!/usr/bin/env bash
set -euo pipefail

# ---- 1. Install Mise (The Tool Manager) ----
# We need to install the actual binary first!
export PATH="$HOME/.local/bin:$HOME/.local/share/mise/shims:$PATH"

if ! command -v mise >/dev/null 2>&1; then
    echo ">>> Installing Mise..."
    curl -fsSL https://mise.run | sh
fi

# Use mise env (not mise activate) â€” activate is for interactive shells only
eval "$(mise env -s bash 2>/dev/null || true)"

# ---- 2. Install Tools (Neovim, Node, Starship, etc.) ----
echo ">>> Installing tools via Mise..."

# We verify and install tools directly in the script.
# This serves as the single source of truth for your toolchain.

# List of tools to install globally
TOOLS=(
    "neovim@latest"
    "node@lts"
    "pixi@latest"
    "starship@latest"
    "usage@latest"
)

# Install each tool globally
for tool in "${TOOLS[@]}"; do
    echo ">>> Installing $tool..."
    mise use --global "$tool"
done

echo ">>> Verifying installation..."
# Sanity check: verify 'starship' was actually installed and is runnable.
if ! mise exec -- starship --version >/dev/null 2>&1; then
    echo "WARNING: Starship not found after mise install. Retrying..."
    mise use --global starship@latest
fi

# Ensure all shims (executable wrappers) are up to date
echo ">>> Reshimming mise..."
mise reshim

echo ">>> Mise tools installed successfully."
