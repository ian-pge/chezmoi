#!/usr/bin/env bash
set -euo pipefail

# Privilege helper
as_root() {
    if [ "$(id -u)" -eq 0 ]; then
        "$@"
    elif command -v sudo >/dev/null 2>&1; then
        sudo "$@"
    else
        echo "ERROR: Not root and 'sudo' is not installed." >&2
        exit 1
    fi
}

# ---- Configure Shell (Fish) ----
SYSTEM_FISH=$(command -v fish)

# Ensure Fish is listed in /etc/shells
if ! grep -qxF "$SYSTEM_FISH" /etc/shells 2>/dev/null; then
    echo ">>> Adding fish to /etc/shells..."
    echo "$SYSTEM_FISH" | as_root tee -a /etc/shells >/dev/null
fi

# Set Fish as default shell (passwd package provides chsh)
CURRENT_SHELL=$(getent passwd "$(whoami)" | cut -d: -f7)
if [ "$CURRENT_SHELL" != "$SYSTEM_FISH" ]; then
    echo ">>> Changing default shell to Fish..."
    as_root chsh -s "$SYSTEM_FISH" "$(whoami)" 2>/dev/null \
        || echo "WARNING: chsh failed â€” update /etc/passwd manually if needed."
fi

# ---- Hook Mise into Fish ----
echo ">>> Hooking Mise into Fish..."
mkdir -p "$HOME/.config/fish/conf.d"
cat > "$HOME/.config/fish/conf.d/mise.fish" <<EOF
# Initialize Mise
if status is-interactive
    command $HOME/.local/bin/mise activate fish | source
else
    command $HOME/.local/bin/mise activate fish --shims | source
end
EOF

echo ">>> Shell configuration complete."
