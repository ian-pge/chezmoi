#!/usr/bin/env bash
set -euo pipefail

# ---- 1. Environment ----
export DEBIAN_FRONTEND=noninteractive
export APT_KEY_DONT_WARN_ON_DANGEROUS_USAGE=1
export TZ="${TZ:-Europe/Paris}"
export LANG=en_US.UTF-8
export LC_ALL=en_US.UTF-8

# Privilege helper
as_root() {
    if [ "$(id -u)" -eq 0 ]; then
        "$@"
    elif command -v sudo >/dev/null 2>&1; then
        sudo "$@"
    else
        echo "ERROR: Not root and 'sudo' is not installed." >&2
        exit 1
    fi
}

echo ">>> Starting Optimized Bootstrap..."

# ---- 1.5 Locale Generation (Early) ----
# Fix locale warnings during subsequent installs
if [ -f /etc/locale.gen ]; then
    if ! grep -q "^en_US.UTF-8 UTF-8" /etc/locale.gen; then
        echo ">>> Generating locales..."
        # Install locales package if missing (minimal images)
        if ! dpkg -s locales >/dev/null 2>&1; then
             as_root apt-get update -qq
             as_root apt-get install -y -qq --no-install-recommends locales
        fi
        echo 'locales locales/default_environment_locale select en_US.UTF-8' | as_root debconf-set-selections
        echo 'locales locales/locales_to_be_generated select en_US.UTF-8 UTF-8' | as_root debconf-set-selections
        as_root locale-gen en_US.UTF-8
    fi
fi

# ---- 2. Prepare Repositories (Fish) ----
# We do this FIRST to consolidate apt-get update/install calls.

. /etc/os-release
REPO_ADDED=0

if [ "$ID" = "ubuntu" ]; then
    # Check if PPA is already added to avoid costly add-apt-repository calls
    if ! grep -q "^deb .*fish-shell/release-4" /etc/apt/sources.list /etc/apt/sources.list.d/*.list 2>/dev/null; then
        echo ">>> Adding fish-shell 4.x PPA..."
        # We need software-properties-common for add-apt-repository
        # This is the only unavoidable intermediate install if missing
        if ! command -v add-apt-repository >/dev/null 2>&1; then
             as_root apt-get update -qq
             as_root apt-get install -y -qq --no-install-recommends software-properties-common
        fi
        as_root add-apt-repository -y ppa:fish-shell/release-4
        # add-apt-repository updates by default on modern Ubuntu
        REPO_ADDED=0 
        APT_UPDATED_BY_PPA=1
    fi
elif [ "$ID" = "debian" ]; then
    FISH_LIST="/etc/apt/sources.list.d/shells-fish-release-4.list"
    if [ ! -f "$FISH_LIST" ]; then
        echo ">>> Adding fish-shell 4.x OBS repo..."
        as_root apt-get update -qq
        as_root apt-get install -y -qq --no-install-recommends curl gnupg

        REPO_URL="https://download.opensuse.org/repositories/shells:/fish:/release:/4/Debian_${VERSION_ID}/"
        
        curl -fsSL "${REPO_URL}Release.key" \
            | gpg --dearmor \
            | as_root tee /etc/apt/trusted.gpg.d/shells_fish_release_4.gpg >/dev/null

        echo "deb ${REPO_URL} /" \
            | as_root tee "$FISH_LIST" >/dev/null
        REPO_ADDED=1
    fi
fi

# ---- 3. System Layer: Install All Packages ----
echo ">>> Updating apt & installing packages..."

# Update if:
# 1. We manually added a repo (Debian) -> REPO_ADDED=1
# 2. We didn't do anything but apt lists are missing -> ! -d ...
# 3. We didn't trigger an update via PPA -> APT_UPDATED_BY_PPA!=1

if [ "${APT_UPDATED_BY_PPA:-0}" != 1 ]; then
    if [ "$REPO_ADDED" -eq 1 ] || [ ! -d /var/lib/apt/lists/partial ]; then
        as_root apt-get update -qq
    fi
fi

# Preconfigure tzdata
echo 'APT::Install-Recommends "false";' | as_root tee /etc/apt/apt.conf.d/99norecommends >/dev/null
as_root ln -sf "/usr/share/zoneinfo/$TZ" /etc/localtime
echo "$TZ" | as_root tee /etc/timezone >/dev/null

# Single install command for everything
PACKAGES=(
    ca-certificates
    curl
    gnupg
    tzdata
    locales
    git
    debconf-utils
    passwd
    fish
)

if [ "$ID" = "ubuntu" ]; then
    PACKAGES+=(software-properties-common)
fi

as_root apt-get install -y -qq --no-install-recommends "${PACKAGES[@]}"


echo ">>> System packages ready."
