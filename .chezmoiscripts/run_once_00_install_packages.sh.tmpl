#!/usr/bin/env bash
set -euo pipefail
[ "${DEBUG:-}" = 1 ] && set -x

# ---- 1. Environment ----
export DEBIAN_FRONTEND=noninteractive
export APT_KEY_DONT_WARN_ON_DANGEROUS_USAGE=1
export TZ="${TZ:-Europe/Paris}"
export LANG=en_US.UTF-8
export LC_ALL=en_US.UTF-8

# Privilege helper — works as root or with sudo
as_root() {
    if [ "$(id -u)" -eq 0 ]; then
        "$@"
    elif command -v sudo >/dev/null 2>&1; then
        sudo "$@"
    else
        echo "ERROR: Not root and 'sudo' is not installed." >&2
        exit 1
    fi
}

echo ">>> Starting Bootstrap for Minimal Image..."

# ---- 2. System Layer: Core Dependencies ----
echo ">>> Updating apt & installing core utils..."
# Enforce no-recommends globally for leaner installs
echo 'APT::Install-Recommends "false";' | as_root tee /etc/apt/apt.conf.d/99norecommends >/dev/null

# Preconfigure tzdata so it never prompts (even if DEBIAN_FRONTEND leaks)
as_root ln -sf "/usr/share/zoneinfo/$TZ" /etc/localtime
echo "$TZ" | as_root tee /etc/timezone >/dev/null

as_root apt-get update -qq -y
as_root apt-get install -y -qq --no-install-recommends \
    ca-certificates \
    curl \
    gnupg \
    tzdata \
    locales \
    git \
    debconf-utils \
    passwd

# Detect distro early — Ubuntu needs software-properties-common for PPA
. /etc/os-release
if [ "$ID" = "ubuntu" ]; then
    as_root apt-get install -y -qq --no-install-recommends software-properties-common
fi

# ---- Fish: install latest (PPA for Ubuntu, OBS for Debian) ----
# Default apt repos ship ancient Fish (3.3 on Ubuntu 22.04, 3.6 on Debian 12).
# Starship needs 3.7+. Use official fish-shell repos for Fish 4.x.
install_fish_latest() {
    # shellcheck source=/dev/null
    . /etc/os-release

    case "$ID" in
        ubuntu)
            # Fish 4.x PPA — official, maintained by the fish-shell team
            echo ">>> Adding fish-shell 4.x PPA for ${PRETTY_NAME}..."
            as_root add-apt-repository -y ppa:fish-shell/release-4
            ;;
        debian)
            # OBS repo — official, maintained by the fish-shell team
            echo ">>> Adding fish-shell 4.x OBS repo for ${PRETTY_NAME}..."
            local repo_url="https://download.opensuse.org/repositories/shells:/fish:/release:/4/Debian_${VERSION_ID}/"

            curl -fsSL "${repo_url}Release.key" \
                | gpg --dearmor \
                | as_root tee /etc/apt/trusted.gpg.d/shells_fish_release_4.gpg >/dev/null

            echo "deb ${repo_url} /" \
                | as_root tee /etc/apt/sources.list.d/shells-fish-release-4.list >/dev/null
            ;;
        *)
            echo "WARNING: Unsupported distro '$ID' — falling back to apt default fish."
            ;;
    esac

    as_root apt-get update -qq -y
    as_root apt-get install -y -qq --no-install-recommends fish
}

install_fish_latest

# Rehash so newly installed binaries are found immediately
hash -r

# Quick sanity check — TLS will fail if the clock is wildly off (common in containers)
echo ">>> System time: $(date)"

# ---- 3. Locale Generation ----
# Minimal images often ship with no locale, which breaks Fish/Nvim/etc.
if [ -f /etc/locale.gen ]; then
    echo ">>> Generating locales..."
    echo 'locales locales/default_environment_locale select en_US.UTF-8' | as_root debconf-set-selections
    echo 'locales locales/locales_to_be_generated select en_US.UTF-8 UTF-8' | as_root debconf-set-selections
    as_root locale-gen en_US.UTF-8
fi

echo ">>> System packages installed successfully."
