#!/usr/bin/env bash
set -euo pipefail

# ---- 1. Environment & Helper Functions ----
export DEBIAN_FRONTEND=noninteractive
export APT_KEY_DONT_WARN_ON_DANGEROUS_USAGE=1
export TZ="${TZ:-Europe/Paris}"
# Note: We do NOT export LANG/LC_ALL here yet.
# We must generate the locales first to avoid Perl warnings during apt-get.

# Privilege helper â€” runs commands as root, using sudo if not already root.
as_root() {
    if [ "$(id -u)" -eq 0 ]; then
        "$@"
    elif command -v sudo >/dev/null 2>&1; then
        sudo "$@"
    else
        echo "ERROR: Not root and 'sudo' is not installed." >&2
        exit 1
    fi
}

echo ">>> Starting Optimized Bootstrap..."

# ---- 2. Locale Generation (Prioritized) ----
# We generate locales FIRST to prevent "perl: warning: Setting locale failed"
# errors during the subsequent package installation steps.
if [ -f /etc/locale.gen ]; then
    if ! grep -q "^en_US.UTF-8 UTF-8" /etc/locale.gen; then
        echo ">>> Generating locales..."
        # Install 'locales' package if missing (common in minimal docker images)
        if ! dpkg -s locales >/dev/null 2>&1; then
             as_root apt-get update -qq
             as_root apt-get install -y -qq --no-install-recommends locales
        fi
        echo 'locales locales/default_environment_locale select en_US.UTF-8' | as_root debconf-set-selections
        echo 'locales locales/locales_to_be_generated select en_US.UTF-8 UTF-8' | as_root debconf-set-selections
        as_root locale-gen en_US.UTF-8
    fi
fi

# Only now is it safe to export the locale
export LANG=en_US.UTF-8
export LC_ALL=en_US.UTF-8

# ---- 3. Configure Repositories (Fish Shell) ----
# We check if repositories are already added to avoid redundant and slow
# 'add-apt-repository' calls.

. /etc/os-release
REPO_ADDED=0

if [ "$ID" = "ubuntu" ]; then
    # Check if PPA is already added
    if ! grep -q "^deb .*fish-shell/release-4" /etc/apt/sources.list /etc/apt/sources.list.d/*.list 2>/dev/null; then
        echo ">>> Adding fish-shell 4.x PPA..."
        if ! command -v add-apt-repository >/dev/null 2>&1; then
             as_root apt-get update -qq
             as_root apt-get install -y -qq --no-install-recommends software-properties-common
        fi
        as_root add-apt-repository -y ppa:fish-shell/release-4
        
        # PPA addition triggers an update automatically on modern Ubuntu
        REPO_ADDED=0 
        APT_UPDATED_BY_PPA=1
    fi
elif [ "$ID" = "debian" ]; then
    FISH_LIST="/etc/apt/sources.list.d/shells-fish-release-4.list"
    if [ ! -f "$FISH_LIST" ]; then
        echo ">>> Adding fish-shell 4.x OBS repo..."
        as_root apt-get update -qq
        as_root apt-get install -y -qq --no-install-recommends curl gnupg

        REPO_URL="https://download.opensuse.org/repositories/shells:/fish:/release:/4/Debian_${VERSION_ID}/"
        
        curl -fsSL "${REPO_URL}Release.key" \
            | gpg --dearmor \
            | as_root tee /etc/apt/trusted.gpg.d/shells_fish_release_4.gpg >/dev/null

        echo "deb ${REPO_URL} /" \
            | as_root tee "$FISH_LIST" >/dev/null
        REPO_ADDED=1
    fi
fi

# ---- 4. Install Packages (Single Pass) ----
echo ">>> Updating apt & installing packages..."

# Update strategy:
# - If we manually added a Debian repo (REPO_ADDED=1) -> Must update.
# - If apt lists are missing (clean environment) -> Must update.
# - If PPA triggered an update -> Skip (APT_UPDATED_BY_PPA=1).
# - Otherwise -> Skip (saves time on re-runs).

if [ "${APT_UPDATED_BY_PPA:-0}" != 1 ]; then
    if [ "$REPO_ADDED" -eq 1 ] || [ ! -d /var/lib/apt/lists/partial ]; then
        as_root apt-get update -qq
    fi
fi

# Preconfigure tzdata to avoid interactive prompts
echo 'APT::Install-Recommends "false";' | as_root tee /etc/apt/apt.conf.d/99norecommends >/dev/null
as_root ln -sf "/usr/share/zoneinfo/$TZ" /etc/localtime
echo "$TZ" | as_root tee /etc/timezone >/dev/null

# Define all packages to install
PACKAGES=(
    ca-certificates
    curl
    gnupg
    tzdata
    locales
    git
    debconf-utils
    passwd
    fish
)

if [ "$ID" = "ubuntu" ]; then
    PACKAGES+=(software-properties-common)
fi

# Install everything in one command for efficiency
as_root apt-get install -y -qq --no-install-recommends "${PACKAGES[@]}"

echo ">>> System packages installed successfully."
