#!/usr/bin/env bash
set -euo pipefail

# ---- Install Mise ----
mkdir -p "$HOME/.local/bin"
export PATH="$HOME/.local/bin:$HOME/.local/share/mise/shims:$PATH"

if ! command -v mise >/dev/null 2>&1; then
    echo ">>> Installing Mise..."
    curl -fsSL https://mise.run | sh
    # We can't really hash -r here effectively for the parent shell, but it helps this script
    hash -r
fi

# Use mise env (not mise activate) â€” activate is for interactive shells only
eval "$(mise env -s bash 2>/dev/null || true)"

# ---- 2. Install Tools (Neovim, Node, Starship, etc.) ----
echo ">>> Installing tools via Mise..."

# CRITICAL: Create the config file explicitly before installing.
# This ensures 'mise install' knows WHAT to install (neovim, node, etc.)
# during the bootstrap process, even if chezmoi hasn't fully applied the dotfiles yet.
mkdir -p "$HOME/.config/mise"
cat > "$HOME/.config/mise/config.toml" <<'EOF'
[tools]
neovim   = "latest"
node     = "lts"
pixi     = "latest"
starship = "latest"
usage    = "latest"
EOF

# Install all tools defined in the config above
mise install --yes

echo ">>> Verifying installation..."
# Sanity check: verify 'starship' was actually installed and is runnable.
# If verification fails, retry the install specifically for starship.
if ! ~/.local/bin/mise exec -- starship --version >/dev/null 2>&1; then
    echo "WARNING: Starship not found after mise install. Retrying..."
    mise install starship --yes
fi

# Ensure all shims (executable wrappers) are up to date
echo ">>> Reshimming mise..."
mise reshim

echo ">>> Mise tools installed successfully."
