#!/usr/bin/env bash
set -euo pipefail
[ "${DEBUG:-}" = 1 ] && set -x

# ---- 1. Environment ----
export DEBIAN_FRONTEND=noninteractive
export APT_KEY_DONT_WARN_ON_DANGEROUS_USAGE=1
export TZ="${TZ:-Europe/Paris}"
export LANG=en_US.UTF-8
export LC_ALL=en_US.UTF-8

# Privilege helper — works as root or with sudo
as_root() {
    if [ "$(id -u)" -eq 0 ]; then
        "$@"
    elif command -v sudo >/dev/null 2>&1; then
        sudo "$@"
    else
        echo "ERROR: Not root and 'sudo' is not installed." >&2
        exit 1
    fi
}

echo ">>> Starting Bootstrap for Minimal Image..."

# ---- 2. System Layer: Core Dependencies ----
echo ">>> Updating apt & installing core utils..."
# Enforce no-recommends globally for leaner installs
echo 'APT::Install-Recommends "false";' | as_root tee /etc/apt/apt.conf.d/99norecommends >/dev/null

as_root apt-get update -qq -y
as_root apt-get install -y -qq --no-install-recommends \
    ca-certificates \
    curl \
    gnupg \
    tzdata \
    locales \
    git \
    debconf-utils \
    passwd \
    fish

# Rehash so newly installed binaries are found immediately
hash -r

# Quick sanity check — TLS will fail if the clock is wildly off (common in containers)
echo ">>> System time: $(date)"

# ---- 3. Locale Generation ----
# Minimal images often ship with no locale, which breaks Fish/Nvim/etc.
if [ -f /etc/locale.gen ]; then
    echo ">>> Generating locales..."
    echo 'locales locales/default_environment_locale select en_US.UTF-8' | as_root debconf-set-selections
    echo 'locales locales/locales_to_be_generated select en_US.UTF-8 UTF-8' | as_root debconf-set-selections
    as_root locale-gen en_US.UTF-8
fi

# ---- 4. Install Mise ----
mkdir -p "$HOME/.local/bin"
export PATH="$HOME/.local/bin:$HOME/.local/share/mise/shims:$PATH"

if ! command -v mise >/dev/null 2>&1; then
    echo ">>> Installing Mise..."
    curl -fsSL https://mise.run | sh
    hash -r
fi

# Use mise env (not mise activate) — activate is for interactive shells only
eval "$(mise env -s bash 2>/dev/null || true)"

# ---- 5. Install Tools via Mise (parallel) ----
echo ">>> Installing tools via Mise..."
mkdir -p "$HOME/.config/mise"
cat > "$HOME/.config/mise/config.toml" <<'EOF'
[tools]
neovim   = "latest"
node     = "lts"
pixi     = "latest"
starship = "latest"
usage    = "latest"
fastfetch = "latest"
EOF

mise install --yes
# Reload shims so tools are on PATH for remainder of script
eval "$(mise env -s bash)"

# ---- 6. Configure Shell (Fish) ----
SYSTEM_FISH=$(command -v fish)

# Ensure Fish is listed in /etc/shells
grep -qxF "$SYSTEM_FISH" /etc/shells 2>/dev/null \
    || echo "$SYSTEM_FISH" | as_root tee -a /etc/shells >/dev/null

# Set Fish as default shell (passwd package provides chsh)
CURRENT_SHELL=$(getent passwd "$(whoami)" | cut -d: -f7)
if [ "$CURRENT_SHELL" != "$SYSTEM_FISH" ]; then
    echo ">>> Changing default shell to Fish..."
    as_root chsh -s "$SYSTEM_FISH" "$(whoami)" 2>/dev/null \
        || echo "WARNING: chsh failed — update /etc/passwd manually if needed."
fi

# ---- 7. Hook Mise into Fish ----
mkdir -p "$HOME/.config/fish/conf.d"
cat > "$HOME/.config/fish/conf.d/mise.fish" <<EOF
# Initialize Mise
if status is-interactive
    command $HOME/.local/bin/mise activate fish | source
else
    command $HOME/.local/bin/mise activate fish --shims | source
end
EOF
