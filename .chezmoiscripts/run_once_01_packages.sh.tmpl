#!/usr/bin/env bash
set -euo pipefail

export DEBIAN_FRONTEND=noninteractive
TZ="${TZ:-Europe/Paris}"

# Use sudo only when needed/available
SUDO=""
if [[ "${EUID:-$(id -u)}" -ne 0 ]]; then
  if command -v sudo >/dev/null 2>&1; then
    SUDO="sudo"
  else
    echo "ERROR: Not root and sudo not available." >&2
    exit 1
  fi
fi

if ! command -v apt-get >/dev/null 2>&1; then
  echo "ERROR: This script currently supports apt-based containers only (Debian/Ubuntu)." >&2
  exit 1
fi

$SUDO apt-get update -qq
$SUDO apt-get install -y --no-install-recommends \
  ca-certificates curl gnupg \
  software-properties-common tzdata locales python3-apt sudo

# ---- Fix add-apt-repository / apt_pkg mismatch (common in conda-based images) ----
fix_add_apt_repository() {
  command -v add-apt-repository >/dev/null 2>&1 || return 0

  # add-apt-repository uses /usr/bin/python3 via shebang; check THAT interpreter.
  if /usr/bin/python3 -c 'import apt_pkg' >/dev/null 2>&1; then
    return 0
  fi

  # Find which Python ABI the installed apt_pkg module is built for.
  local so tag pyver
  so="$(ls /usr/lib/python3/dist-packages/apt_pkg*.so 2>/dev/null | head -n 1 || true)"
  if [[ -z "$so" ]]; then
    # Try reinstalling python3-apt (rare, but cheap)
    $SUDO apt-get install -y --reinstall python3-apt
    so="$(ls /usr/lib/python3/dist-packages/apt_pkg*.so 2>/dev/null | head -n 1 || true)"
  fi

  if [[ "$so" =~ cpython-([0-9]{2,3}) ]]; then
    tag="${BASH_REMATCH[1]}"          # e.g. 310, 38, 311
    pyver="${tag:0:1}.${tag:1}"       # -> 3.10, 3.8, 3.11

    if [[ -x "/usr/bin/python${pyver}" ]]; then
      # Make the shebang interpreter match the distro Python that can load apt_pkg.
      $SUDO ln -sf "/usr/bin/python${pyver}" /usr/bin/python3
    fi
  fi

  # Last resort: patch the shebang directly (in case /usr/bin/python3 is managed elsewhere)
  if ! /usr/bin/python3 -c 'import apt_pkg' >/dev/null 2>&1 && [[ -n "${pyver:-}" && -x "/usr/bin/python${pyver}" ]]; then
    $SUDO sed -i "1 s|^#!.*python3.*$|#!/usr/bin/python${pyver}|" /usr/bin/add-apt-repository
  fi

  # Final check (so failures are clear)
  /usr/bin/python3 -c 'import apt_pkg' >/dev/null 2>&1 || {
    echo "ERROR: apt_pkg still not importable by /usr/bin/python3; cannot use add-apt-repository." >&2
    return 1
  }
}
fix_add_apt_repository || true

# ---- Timezone & locale preset ----
$SUDO ln -fs "/usr/share/zoneinfo/$TZ" /etc/localtime
echo "$TZ" | $SUDO tee /etc/timezone >/dev/null

echo 'locales locales/default_environment_locale select en_US.UTF-8' | $SUDO debconf-set-selections
echo 'locales locales/locales_to_be_generated select en_US.UTF-8 UTF-8' | $SUDO debconf-set-selections
$SUDO locale-gen en_US.UTF-8
$SUDO update-locale LANG=en_US.UTF-8

# ---- Repositories (Ubuntu-only PPAs; skip on non-Ubuntu) ----
if [[ -r /etc/os-release ]]; then
  . /etc/os-release
fi

if [[ "${ID:-}" == "ubuntu" ]] && command -v add-apt-repository >/dev/null 2>&1; then
  # If PPAs fail (network/minimal images), don't hard-fail your whole bootstrap.
  $SUDO add-apt-repository -y ppa:fish-shell/release-3 || true
  $SUDO add-apt-repository -y ppa:neovim-ppa/unstable || true
  $SUDO apt-get update -qq
fi

# ---- Packages ----
$SUDO apt-get install -y --no-install-recommends \
  git fish neovim fzf fd-find bat fastfetch curl

# ---- fd / bat symlinks (Debian/Ubuntu naming quirks) ----
mkdir -p ~/.local/bin

if ! command -v fd >/dev/null 2>&1 && command -v fdfind >/dev/null 2>&1; then
  ln -sf "$(command -v fdfind)" ~/.local/bin/fd
fi

if ! command -v bat >/dev/null 2>&1 && command -v batcat >/dev/null 2>&1; then
  ln -sf "$(command -v batcat)" ~/.local/bin/bat
fi

# ---- Starship prompt ----
curl -fsSL https://starship.rs/install.sh | sh -s -- -y -b ~/.local/bin

# ---- Fish as default shell (best-effort in containers) ----
if command -v fish >/dev/null 2>&1; then
  if ! grep -q '^/usr/bin/fish$' /etc/shells; then
    echo /usr/bin/fish | $SUDO tee -a /etc/shells >/dev/null
  fi
  $SUDO chsh -s /usr/bin/fish "$(whoami)" 2>/dev/null || true
fi

# ---- Clean up ----
$SUDO apt-get clean
$SUDO rm -rf /var/lib/apt/lists/*
