#!/usr/bin/env bash
set -euo pipefail

# Export for current shell
export DEBIAN_FRONTEND=noninteractive
export APT_KEY_DONT_WARN_ON_DANGEROUS_USAGE=1
# Pixi needs ~/.local/bin in PATH usually, ensuring it receives it
export PATH="$HOME/.local/bin:$HOME/.pixi/bin:$PATH"
TZ="${TZ:-Europe/Paris}"

# Use sudo only when needed/available
SUDO=""
if [[ "${EUID:-$(id -u)}" -ne 0 ]]; then
  if command -v sudo >/dev/null 2>&1; then
    SUDO="sudo"
  else
    echo "ERROR: Not root and sudo not available." >&2
    exit 1
  fi
fi

# Wrapper to run apt commands non-interactively even with sudo
run_apt() {
    $SUDO DEBIAN_FRONTEND=noninteractive apt-get "$@"
}

# Ensure basic tools for script execution
# Minimal set needed for Pixi and basic shell setup
ensure_basic_deps() {
    # Pre-seed timezone to avoid tzdata prompt
    echo "$TZ" | $SUDO tee /etc/timezone >/dev/null || true
    if [[ -f "/usr/share/zoneinfo/$TZ" ]]; then
        $SUDO ln -fs "/usr/share/zoneinfo/$TZ" /etc/localtime
    fi

    # Check for core dependencies before running updates
    if ! command -v curl >/dev/null 2>&1 || ! command -v python3 >/dev/null 2>&1; then
         run_apt update -qq -y
         run_apt install -y -qq --no-install-recommends \
            -o Dpkg::Options::="--force-confnew" \
            -o Dpkg::Options::="--force-confdef" \
            ca-certificates curl gnupg tzdata locales tar sudo
            # unzip often useful for manual installs, but tar is essential
    fi

    # Ensure locales are generated to avoid perl warnings
    if command -v locale-gen >/dev/null 2>&1; then
        echo 'locales locales/default_environment_locale select en_US.UTF-8' | $SUDO debconf-set-selections
        echo 'locales locales/locales_to_be_generated select en_US.UTF-8 UTF-8' | $SUDO debconf-set-selections
        $SUDO locale-gen en_US.UTF-8 >/dev/null 2>&1 || true
    fi
}

ensure_basic_deps

# ---- Install Pixi ----
if ! command -v pixi >/dev/null 2>&1; then
    echo "Installing Pixi..."
    curl -fsSL https://pixi.sh/install.sh | bash
fi

# ---- Install Tools via Pixi ----
# Global install provides binaries in ~/.pixi/bin
# We specific versions if critical, but generic install implies latest stable at time of run
# Pixi is fast and resolves deps without system interference

install_tool() {
    local tool="$1"
    local package="${2:-$1}" # Package name can differ from tool name
    
    if ! command -v "$tool" >/dev/null 2>&1; then
        echo "Installing $tool via pixi..."
        pixi global install "$package"
    fi
}

install_tool neovim nvim
install_tool fish
install_tool bat
install_tool fd fd-find
install_tool fzf
install_tool starship
install_tool fastfetch
install_tool git

# ---- Configure Shell ----

# Add pixi to path in case it wasn't picked up immediately for this shell session
export PATH="$HOME/.pixi/bin:$PATH"

# Configured Shell
# To safely use a user-installed shell as default, we symlink it to a standard system path.
# This ensures it is available during login even if ~/.pixi/bin isn't in the initial PATH.

FISH_BIN="$HOME/.pixi/bin/fish"
SYSTEM_FISH="/usr/local/bin/fish"

if [[ -x "$FISH_BIN" ]]; then
  # Create a system-wide symlink if possible
  if [[ ! -e "$SYSTEM_FISH" ]]; then
      $SUDO ln -sf "$FISH_BIN" "$SYSTEM_FISH"
  fi

  # Add to /etc/shells if missing
  if ! grep -q "^$SYSTEM_FISH$" /etc/shells; then
    echo "$SYSTEM_FISH" | $SUDO tee -a /etc/shells >/dev/null
  fi
  
  # Change default shell
  if [[ -w /etc/passwd ]] || command -v chsh >/dev/null 2>&1; then
      $SUDO chsh -s "$SYSTEM_FISH" "$(whoami)" 2>/dev/null || true
  fi
fi

# Cleanup system apt cache to keep image small (if we used apt)
if [[ -d /var/lib/apt/lists ]]; then
    run_apt clean
    $SUDO rm -rf /var/lib/apt/lists/*
fi

